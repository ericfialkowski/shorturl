services:
  # ============== MongoDB Profile ==============
  mongo:
    image: mongo
    container_name: shorturldb
    restart: always
    profiles: [mongo]
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: p@ssw0rd!

  mongo-express:
    image: mongo-express
    container_name: shorturldb-express
    restart: always
    profiles: [mongo]
    depends_on: [mongo]
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://root:p%40ssw0rd!@mongo
      ME_CONFIG_BASICAUTH_USERNAME: dbadmin
      ME_CONFIG_BASICAUTH_PASSWORD: p@ssw0rd!

  short-url-mongo:
    build:
      context: ..
      dockerfile: Dockerfile
    image: short-url
    hostname: shorturl
    profiles: [mongo]
    depends_on: [mongo, otel-collector]
    expose:
      - "8810"
    environment:
      mongo_uri: mongodb://root:p%40ssw0rd!@mongo/admin
      logrequests: "true"
      port: 8810
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_SERVICE_NAME: shorturl

  # ============== PostgreSQL Profile ==============
  postgres:
    image: postgres:16-alpine
    container_name: shorturldb-postgres
    restart: always
    profiles: [postgres]
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: shorturl
      POSTGRES_PASSWORD: p@ssw0rd!
      POSTGRES_DB: shorturl
    volumes:
      - postgres_data:/var/lib/postgresql/data

  pgadmin:
    image: dcagatay/pwless-pgadmin4:latest
    container_name: shorturldb-pgadmin
    restart: always
    profiles: [postgres]
    depends_on: [postgres]
    ports:
      - "8082:80"
    environment:
      POSTGRES_USER: shorturl
      POSTGRES_PASSWORD: p@ssw0rd!
      POSTGRES_DB: shorturl
      POSTGRES_HOST: postgres
      PGADMIN_DISABLE_POSTFIX: true

  short-url-postgres:
    build:
      context: ..
      dockerfile: Dockerfile
    image: short-url
    hostname: shorturl
    profiles: [postgres]
    depends_on: [postgres, otel-collector]
    expose:
      - "8810"
    environment:
      postgres_uri: postgres://shorturl:p%40ssw0rd!@postgres:5432/shorturl
      logrequests: "true"
      port: 8810
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_SERVICE_NAME: shorturl

  # ============== MySQL Profile ==============
  mysql:
    image: mysql:8
    container_name: shorturldb-mysql
    restart: always
    profiles: [mysql]
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_USER: shorturl
      MYSQL_PASSWORD: shorturl123
      MYSQL_DATABASE: shorturl
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-ushorturl", "-pshorturl123"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: shorturldb-phpmyadmin
    restart: always
    profiles: [mysql]
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "8083:80"
    environment:
      PMA_HOST: mysql
      PMA_USER: shorturl
      PMA_PASSWORD: shorturl123

  short-url-mysql:
    build:
      context: ..
      dockerfile: Dockerfile
    image: short-url
    hostname: shorturl
    profiles: [mysql]
    depends_on:
      mysql:
        condition: service_healthy
      otel-collector:
        condition: service_started
    expose:
      - "8810"
    environment:
      mysql_dsn: shorturl:shorturl123@tcp(mysql:3306)/shorturl
      logrequests: "true"
      port: 8810
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_SERVICE_NAME: shorturl

  # ============== Redis Profile ==============
  redis:
    image: redis:7-alpine
    container_name: shorturldb-redis
    restart: always
    profiles: [redis]
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: shorturldb-redis-commander
    restart: always
    profiles: [redis]
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8084:8081"
    environment:
      REDIS_HOSTS: local:redis:6379

  short-url-redis:
    build:
      context: ..
      dockerfile: Dockerfile
    image: short-url
    hostname: shorturl
    profiles: [redis]
    depends_on:
      redis:
        condition: service_healthy
      otel-collector:
        condition: service_started
    expose:
      - "8810"
    environment:
      redis_uri: redis://redis:6379/0
      logrequests: "true"
      port: 8810
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_SERVICE_NAME: shorturl

  # ============== In-Memory Profile ==============
  short-url-memory:
    build:
      context: ..
      dockerfile: Dockerfile
    image: short-url
    hostname: shorturl
    profiles: [memory]
    depends_on: [otel-collector]
    expose:
      - "8810"
    environment:
      # No database URI - uses in-memory storage
      logrequests: "true"
      port: 8810
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_SERVICE_NAME: shorturl

  nginx-memory:
    image: nginx:latest
    container_name: nginx
    profiles: [memory]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on: [short-url-memory]
    ports:
      - "8800:8800"

  # ============== Shared Services ==============
  otel-collector:
    image: otel/opentelemetry-collector:latest
    container_name: otel-collector
    restart: always
    profiles: [mongo, postgres, mysql, redis, memory]
    volumes:
      - ./otel-collector-config.yaml:/etc/otelcol/config.yaml:ro
    ports:
      - "4318:4318"   # OTLP HTTP receiver
      - "8888:8888"   # Prometheus metrics (collector self-metrics)
      - "8889:8889"   # Prometheus exporter (application metrics)

  nginx-mongo:
    image: nginx:latest
    container_name: nginx
    profiles: [mongo]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on: [short-url-mongo]
    ports:
      - "8800:8800"

  nginx-postgres:
    image: nginx:latest
    container_name: nginx
    profiles: [postgres]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on: [short-url-postgres]
    ports:
      - "8800:8800"

  nginx-mysql:
    image: nginx:latest
    container_name: nginx
    profiles: [mysql]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on: [short-url-mysql]
    ports:
      - "8800:8800"

  nginx-redis:
    image: nginx:latest
    container_name: nginx
    profiles: [redis]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on: [short-url-redis]
    ports:
      - "8800:8800"

volumes:
  postgres_data:
  pgadmin_data:
  mysql_data:
  redis_data:
